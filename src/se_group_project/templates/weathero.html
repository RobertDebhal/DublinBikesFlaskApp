<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>
		Dublin Bikes
	</title>
    <!-- credit to fontawesome.io -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- credit to fontawesome.io --> 
    <link rel="stylesheet" type="text/css" href="static/Assignment3_css.css">
	<style>
.dropbtn {
    background-color:  #333333;
    color: white;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    background-color: #737373;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f1f1f1;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
}

.dropdown-content a {
    color: black;
    padding: 10px 10px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #ddd}

.show {display:block;}
	</style>
</head>
<body id="body">
	<!-------------------------------------------Above the navbar -------------------------->
    <div class="wrapper" style="width:95%">
    <div style="height:80px;overflow:hidden;margin:0">
    <div style="width:40%;float:left;">
    <h1 style="margin-top:25px;">Dublin Bikes</h1>
    </div>
    <div style="width:50%;float:left;">
    <a href=http://www.dublinbikes.ie/ target="_blank"><img alt="Bike Logo" src="static/bike_logo.jpeg" style="float:right" class = "logo_image"></a>
    </div>
    </div>
    </div>
	<!------------------------------------------- Navbar ----------------------------------->
    <nav>
        <div style="margin-bottom:0px;">
        <ul class="grad2">
    <li style="margin-left: 10%" class="active"><a href="Index.php">Enter Your Location</a></li>
    <li style="float:right;margin-right:12.5%;"><a href=https://www.instagram.com/explore/tags/dublinbikes/ target="_blank" class="icon" style="min-height:63px;"><i class="fa fa-instagram fa-fw" style="font-size:35px;"></i></a></li> 
    <li style="float:right;"><a href=https://www.facebook.com/dublinbikes/  target="_blank" class="icon" style="min-height:63px;"><i class="fa fa-facebook fa-fw" style="font-size:35px"></i></a></li>
    <li style="float:right;"><a href=https://twitter.com/dublinbikes2go target="_blank" class="icon" style="min-height:63px;"><i class="fa fa-twitter fa-fw" style="font-size:35px"></i></a></li> 
        </ul>
    </div>
    </nav>
    <!--<br> <br><br>-->
    <div class="wrapper" style="width:80%">
    <div id=".loc" style="width:50%;float:left;min-height:25px;">
    </div>
    <div style="width:50%;float:left;min-height:25px;">
    </div>
    </div>
	<!-------------------------------------------Map ------------------------------------->
	<div id="map" style="width:100%;height:400px"></div>
	<!-------------------------------------------Charts------------------------------------->
	  <div class="wrapper" style="width:95%">
		  
    <div style="width:10%;float:left;min-height:25px;">  
	</div>
	<div  style="width:10%;float:left;min-height:25px;">
    </div>
    <div  style="width:30%;float:left;min-height:25px;">
    </div>
	<div  style="width:50%;float:left;min-height:25px;">
    </div>
		  
	<!-- ------------------------ Day dropdown------------------> 
		  
	<div class="dropdown"  style="width:10%;float:left;">
	<button onclick="myFunction()" class="dropbtn">Select a Day</button>
  	<div id="myDropdown" class="dropdown-content">
		<a href="#home">Monday</a>
		<a href="#about">Tuesday</a>
		<a href="#home">Wednesday</a>
		<a href="#contact">Thursday</a>
		<a href="#home">Friday</a>
		<a href="#home">Saturday</a>
		<a href="#home">Sunday</a>    
  	</div>
	</div>	 
		  
	<!-- --------------------Hour dropdown-----------------------> 

	<div class="dropdown"  style="width:10%;float:left;">
	<button onclick="myFunction2()" class="dropbtn">Select a Time</button>
  	<div id="myDropdown2" class="dropdown-content">
		<a href="#home">6am</a>
		<a href="#about">7am</a>
		<a href="#home">8am</a>
		<a href="#home">9am</a>
		<a href="#home">10am</a>
		<a href="#home">11am</a>
		<a href="#home">12 noon</a>    
		<a href="#home">1pm</a> 
		<a href="#home">2pm</a> 
		<a href="#home">3pm</a> 
		<a href="#home">4pm</a> 
		<a href="#home">5pm</a> 
		<a href="#home">6pm</a>
		<a href="#about">7pm</a>
		<a href="#home">8pm</a>
		<a href="#home">9pm</a>
		<a href="#home">10pm</a>
		<a href="#home">11pm</a>
		<a href="#home">12 midnight</a>    
		<a href="#home">1am</a> 
		<a href="#home">2am</a> 
		<a href="#home">3am</a> 
		<a href="#home">4am</a> 
		<a href="#home">5am</a> 
  	</div>
	</div>	 		  
		  
		  
		  
		  
    <div id="graph1"style="width:30%;float:left;">
    </div>
    <div id="graph2" style="width:50%;float:left;">
    </div>
		  
    </div>
    <!-- -----------------------------------form and footer ------------------------------->
    <div class="grad2 footertop">
            
            <form style="margin-right:5%">
              Name:
            <input type="text" name="firstname">
              Email:
            <input type="text" name="lastname">
            <input type="submit" style="width:100px;height:24px;">
            </form>
            <h5 style="font-weight:none;">Join our Mailing List!</h5>
    </div>
    
    <div class="footer grad2" style="padding:10px 0px 20px 0px;min-height:130px;">

    <ul style="list-style-type:none;padding:0;font-weight:none;">    
        <li><h5 style="font-family:sans-serif;">Copyright Dublin Bikes Â©</h5></li>
    </ul>
</div>
    
    </body>
	
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<!--http://biostall.com/loading-infowindow-content-using-ajax-with-google-maps-api/-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script>
		

		
		
		
// https://www.w3schools.com/howto/howto_js_dropdown.asp
function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
}

function myFunction2() {
    document.getElementById("myDropdown2").classList.toggle("show");
}
		
		
// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {

    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}	
		
		
		
var lastOpenedInfoWindow;
var parsedObj;
var stationsLatestData;

function myMap() {
	// https://www.w3schools.com/js/js_json_http.asp
	function checkNumbers(url) {
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				parsedObj = JSON.parse(this.responseText);
				myFunction(parsedObj);

			}
		};
		xmlhttp.open("GET", url, true);
		xmlhttp.send();
	}

	function myFunction(arr) {
		var mapOptions = {
			center: new google.maps.LatLng(53.350140, -6.266155),
			zoom: 14,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		var map = new google.maps.Map(document.getElementById("map"), mapOptions);
		var i;
		for (i = 0; i < arr.length; i++) {
			var radiusOut;
			var colorOut;
			var ratio = arr[i].available_bikes / arr[i].bike_stands;
			if (ratio < 0.001) {
				colorOut = '#FF0000';
				radiusOut = 40;
			} else if (ratio < .6 && ratio > 0.001) {
				colorOut = '#0000FF';
				radiusOut = 60;
			} else {
				colorOut = '#0000FF';
				radiusOut = 100 * ratio;
			}
			var cityCircle = new google.maps.Circle({
				strokeColor: colorOut,
				strokeOpacity: 0.8,
				strokeWeight: 0.5,
				fillColor: colorOut,
				fillOpacity: 0.35,
				map: map,
				center: {
					lat: arr[i].lat,
					lng: arr[i].lng
				},
				position: {
					lat: arr[i].lat,
					lng: arr[i].lng
				},
				radius: radiusOut,
				number: arr[i].number
			});
			var contentString;

			var infowindow = new google.maps.InfoWindow();
			var num = cityCircle.number;
			google.maps.event.addListener(cityCircle, 'click', (function(cityCircle, contentString, infowindow) {
				return function() {
					document.location.href = "#.loc";
					$.ajax({
						url: "http://localhost:5000/available/" + cityCircle.number,
						success: function(data) {
							infowindow.setContent('<b>Station Number: ' + data[0].number + '</b><br>' + data[0].address + '<br>Available bikes: ' + data[0].available_bikes + "<br>Available stands: " + data[0].available_bike_stands);
							infowindow.open(map, cityCircle);
							closeLastOpenedInfoWindow();
							lastOpenedInfoWindow = infowindow;

							// if  infowindow.setContent, infowindow.open, closeLastOpenedInfoWindow, lastOpenedInfoWindow  are above google.charts 1st  			

							google.charts.load('current', {
								'packages': ['corechart', 'bar']
							});
							google.charts.setOnLoadCallback(init_iwc);
							google.charts.load('current', {
								'packages': ['corechart']
							});
							google.charts.setOnLoadCallback(init);

						}
					});

					function init() {
						drawPieChart(cityCircle);
					}

					function init_iwc() {
						drawInfoWindowChart(cityCircle);
					}

					function drawInfoWindowChart(cityCircle) {

						var jqxhr = $.getJSON("http://localhost:5000/rain/" + cityCircle.number, function(data) {


							var chart_data = new google.visualization.DataTable();
							chart_data.addColumn('timeofday', 'Time of Day');
							chart_data.addColumn('number', 'available_bikes')
							chart_data.addColumn('number', 'available_bike_stands');
							var i;
							var listRaining = [];
							var listNotRaining = [];
							var j;
							for (j = 0; j < 24; j++) {
								listRaining[j] = 0;
								listNotRaining[j] = 0;
							}
							for (i = 0; i < data.length; i++) {
								if (data[i].rain_status == "Raining") {
									listRaining[data[i].hours] = data[i].average_available_rain;
								} else {
									listNotRaining[data[i].hours] = data[i].average_available_no_rain;
								}
							}
							console.log(listRaining);

							var k;
							for (k = 0; k < 24; k++) {
								chart_data.addRows([
									[{
										v: [k, 0, 0],
										f: 'k am'
									}, listRaining[k], listNotRaining[k]]
								]);
							}

							var options = {
								title: 'Availability',
								colors: ['#9575cd',
									'#33ac71'
								],
								hAxis: {
									title: 'Time of Day',
									viewWindow: {
										min: [3, 30, 0],
										max: [23, 30, 0]
									}
								},
								vAxis: {
									title: '#'
								}
							};
							var chart = new google.visualization.ColumnChart(
								document.getElementById('graph2'));

							chart.draw(chart_data, options);
						})



					}

					function drawPieChart(cityCircle) {
						var jqxhr = $.getJSON("http://localhost:5000/available/" + cityCircle.number, function(data) {


							var chart_data = google.visualization.arrayToDataTable([
								['Status', 'Number of bikes'],
								['Available bikes', data[0].available_bikes],
								['Available bike stands', data[0].available_bike_stands]
							]);

							var options = {
								title: 'Bike availability'
							};
							var chart = new google.visualization.PieChart(document.getElementById('graph1'));

							chart.draw(chart_data, options);
						})
					}
				}
			})(cityCircle, contentString, infowindow));
		}


		function closeLastOpenedInfoWindow() {
			if (lastOpenedInfoWindow) {
				lastOpenedInfoWindow.close();
			}
		}
	}
	checkNumbers("http://localhost:5000/orlaJSON");

}
		
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?callback=myMap&key=AIzaSyDnhjzNlsrZqK3A_HtAfH0ya2hmN0qQAzs" async defer ></script>
	
  
</html>

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>
		Dublin Bikes
	</title>
    <!-- credit to fontawesome.io -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- credit to fontawesome.io --> 
    <link rel="stylesheet" type="text/css" href="static/Assignment3_css.css">
</head>
<body id="body">
	
    <div class="wrapper" style="width:80%">
    <div style="height:80px;overflow:hidden;margin:0">
    <div style="width:50%;float:left;">
    <h1 style="margin-top:25px;">Dublin Bikes</h1>
    </div>
    <div style="width:50%;float:left;">
    <img alt="Bike Logo" src="static/bike_logo.jpeg" style="float:right">
    </div>
    </div>
    </div>

    <nav>
        <div style="margin-bottom:0px;">
        <ul class="grad2">
    <li style="margin-left: 10%" class="active"><a href="Index.php">Enter Your Location</a></li>
    <li style="float:right;margin-right:12.5%;"><a href=# class="icon" style="min-height:63px;"><i class="fa fa-instagram fa-fw" style="font-size:35px;"></i></a></li> 
    <li style="float:right;"><a href=# class="icon" style="min-height:63px;"><i class="fa fa-facebook fa-fw" style="font-size:35px"></i></a></li>
    <li style="float:right;"><a href=# class="icon" style="min-height:63px;"><i class="fa fa-twitter fa-fw" style="font-size:35px"></i></a></li> 
        </ul>
    </div>
    </nav>
    <!--<br> <br><br>-->
    <div class="wrapper" style="width:80%">
    <div id=".loc" style="width:50%;float:left;min-height:25px;">
    </div>
    <div style="width:50%;float:left;min-height:25px;">
    </div>
    </div>
	<div id="map" style="width:100%;height:400px"></div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<!--http://biostall.com/loading-infowindow-content-using-ajax-with-google-maps-api/-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script>
		var lastOpenedInfoWindow;
		var parsedObj;
		var stationsLatestData;
		
		function myMap() {
 // https://www.w3schools.com/js/js_json_http.asp
             function checkNumbers(url) {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			parsedObj = JSON.parse(this.responseText);
            myFunction(parsedObj);
			
		}
	};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
             }
			
        function myFunction(arr) {
			var mapOptions = {
				center: new google.maps.LatLng(53.350140, -6.266155),
				zoom: 14,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			}
		var map = new google.maps.Map(document.getElementById("map"), mapOptions);
        var i;
         for(i = 0; i < arr.length; i++){
            var radiusOut;
			var colorOut;
            var ratio = arr[i].available_bikes/arr[i].bike_stands;
            if (ratio<0.001){
                colorOut='#FF0000';
			    radiusOut=40;
            } 
			else if (ratio<.6&&ratio>0.001){
			    colorOut='#0000FF';
			    radiusOut=60;
			}
			else{
			    colorOut='#0000FF';
			    radiusOut=100*ratio;
			}
            var cityCircle = new google.maps.Circle({
                strokeColor: colorOut,
                strokeOpacity: 0.8,
                strokeWeight: 0.5,
                fillColor: colorOut,
                fillOpacity: 0.35,
                map: map,
                center:{lat:arr[i].lat,lng:arr[i].lng},
                position: {lat:arr[i].lat,lng:arr[i].lng},
                radius: radiusOut,
				number: arr[i].number
            });
            var contentString;
            
            var infowindow = new google.maps.InfoWindow();
            var num = cityCircle.number;
           google.maps.event.addListener(cityCircle,'click',(function( cityCircle,contentString,infowindow) {
               return function(){ 
				     document.location.href="#.loc";
				   $.ajax({  
                url: "http://localhost:5000/available/"+cityCircle.number,  
                success: function(data) { 
                        infowindow.setContent('<b>Station Number: '+data[0].number +'</b><br>'+ data[0].address+'<br>Available bikes: '+data[0].available_bikes+"<br>Available stands: "+data[0].available_bike_stands);  
						infowindow.open(map, cityCircle);
						closeLastOpenedInfoWindow();
						lastOpenedInfoWindow = infowindow; 
					
						// if  infowindow.setContent, infowindow.open, closeLastOpenedInfoWindow, lastOpenedInfoWindow  are above google.charts 1st  			
					
                        google.charts.load('current', {'packages': ['corechart','bar']});
                        google.charts.setOnLoadCallback(init_iwc);
						google.charts.load('current', {'packages':['corechart']});
                    	google.charts.setOnLoadCallback(init);
						
                }  
            });     
				   function init(){
				       drawPieChart(cityCircle);
				   }
				   function init_iwc(){
				       drawInfoWindowChart(cityCircle);
				   }
				   
				   function drawInfoWindowChart(cityCircle) {
					   
				    var jqxhr = $.getJSON("http://localhost:5000/rain/" +cityCircle.number,      function (data) {		
				 
				 
				 var chart_data = new google.visualization.DataTable();
				 chart_data.addColumn('timeofday', 'Time of Day');
				 chart_data.addColumn('number', 'available_bikes')
				 chart_data.addColumn('number', 'available_bike_stands');
				var i;
				var listRaining=[];
				var listNotRaining=[];
				var j;
				for (j=0;j<24;j++){
					listRaining[j]=0;
					listNotRaining[j]=0;
				}
				for (i = 0;i<data.length;i++){
				    if(data[i].rain_status=="Raining"){
						listRaining[data[i].hours]=data[i].average_available_rain;
					}
					else{
						listNotRaining[data[i].hours]=data[i].average_available_no_rain;
					}
				}		
				console.log(listRaining);
				chart_data.addRows([[{v: [0, 0, 0], f: '9 am'},listRaining[0],listNotRaining[0]],
									[{v: [1, 0, 0], f: '9 am'},listRaining[1],listNotRaining[1]],
									[{v: [2, 0, 0], f: '9 am'},listRaining[2],listNotRaining[2]],
									[{v: [3, 0, 0], f: '9 am'},listRaining[3],listNotRaining[3]],
									[{v: [4, 0, 0], f: '9 am'},listRaining[4],listNotRaining[4]],
									[{v: [5, 0, 0], f: '9 am'},listRaining[5],listNotRaining[5]],
									[{v: [6, 0, 0], f: '9 am'},listRaining[6],listNotRaining[6]],
									[{v: [7, 0, 0], f: '9 am'},listRaining[7],listNotRaining[7]],
									[{v: [8, 0, 0], f: '9 am'},listRaining[8],listNotRaining[8]],
									[{v: [9, 0, 0], f: '9 am'},listRaining[9],listNotRaining[9]],
									[{v: [10, 0, 0], f: '9 am'},listRaining[10],listNotRaining[10]],
									[{v: [11, 0, 0], f: '9 am'},listRaining[11],listNotRaining[11]],
									[{v: [12, 0, 0], f: '9 am'},listRaining[12],listNotRaining[12]],
									[{v: [13, 0, 0], f: '9 am'},listRaining[13],listNotRaining[13]],
									[{v: [14, 0, 0], f: '9 am'},listRaining[14],listNotRaining[14]],
									[{v: [15, 0, 0], f: '9 am'},listRaining[15],listNotRaining[15]],
									[{v: [16, 0, 0], f: ' 11 am'},listRaining[16],listNotRaining[16]],
								   [{v: [17, 0, 0], f: ' 1 pm'},listRaining[17],listNotRaining[17]],
								   [{v: [18, 0, 0], f: '3 pm'},listRaining[18],listNotRaining[18]],
								   [{v: [19, 0, 0], f: '3 pm'},listRaining[19],listNotRaining[19]],
								   [{v: [20, 0, 0], f: '3 pm'},listRaining[20],listNotRaining[20]],
								   [{v: [21, 0, 0], f: '3 pm'},listRaining[21],listNotRaining[21]],
								   [{v: [22, 0, 0], f: '3 pm'},listRaining[22],listNotRaining[22]],
								   [{v: [23, 0, 0], f: '5 pm'},listRaining[23],listNotRaining[23]]]);		
						
						
						
						
				var options = {
					 title: 'Availability',
					 colors: ['#9575cd',
					'#33ac71'],
					 hAxis: {
					 title: 'Time of Day',
					 viewWindow: {
            min: [7, 30, 0],
            max: [17, 30, 0]
          }
					 },
					 vAxis: { title: '#'
					 }
 };
var chart = new google.visualization.ColumnChart(
        					document.getElementById('graph2'));

      					chart.draw(chart_data, options);
         })	
					  
					   
			
         }
				  		
                 	 function drawPieChart(cityCircle) {
			 var jqxhr = $.getJSON("http://localhost:5000/available/" +cityCircle.number,      function (data) {		
				 
				 
				 var chart_data = google.visualization.arrayToDataTable([
          ['Status', 'Number of bikes'],
			 ['Available bikes',  data[0].available_bikes  ],
			['Available bike stands',data[0].available_bike_stands  ]
        ]);
				 		
				var options = {
					 title: 'Bike availability'
 };
		  var chart = new google.visualization.PieChart(document.getElementById('graph1'));

      					chart.draw(chart_data, options);
         })		
			 }  
               }
        })(cityCircle,contentString,infowindow)); 
        }
    
         
        function closeLastOpenedInfoWindow(){
			if (lastOpenedInfoWindow) {
        lastOpenedInfoWindow.close();
    }
}
        }
                checkNumbers("http://localhost:5000/orlaJSON");		
		
	}		
		
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?callback=myMap&key=AIzaSyDnhjzNlsrZqK3A_HtAfH0ya2hmN0qQAzs" async defer ></script>
	
    <div class="wrapper" style="width:80%">
    <div style="width:50%;float:left;min-height:25px;">
    </div>
    <div  style="width:50%;float:left;min-height:25px;">
    </div>
    <div id="graph1"style="width:50%;float:left;">
    </div>
    <div id="graph2" style="width:50%;float:left;">
    </div>
    </div>
    
    <div class="grad2 footertop">
            
            <form style="margin-right:5%">
              Name:
            <input type="text" name="firstname">
              Email:
            <input type="text" name="lastname">
            <input type="submit" style="width:100px;height:24px;">
            </form>
            <h5 style="font-weight:none;">Join our Mailing List!</h5>
    </div>
    
    <div class="footer grad2" style="padding:10px 0px 20px 0px;min-height:130px;">

    <ul style="list-style-type:none;padding:0;font-weight:none;">    
        <li><h5 style="font-family:sans-serif;">Copyright Dublin Bikes ©</h5></li>
    </ul>
</div>
    
    </body>
</html>

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>
		Dublin Bikes
	</title>
    <!-- credit to fontawesome.io -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- credit to fontawesome.io --> 
    <link rel="stylesheet" type="text/css" href="static/Assignment3_css.css">
</head>
<body id="body">
	
    <div class="wrapper" style="width:80%">
    <div style="height:80px;overflow:hidden;margin:0">
    <div style="width:50%;float:left;">
    <h1 style="margin-top:25px;">Dublin Bikes</h1>
    </div>
    <div style="width:50%;float:left;">
    <img alt="Bike Logo" src="static/bike_logo.jpeg" style="float:right">
    </div>
    </div>
    </div>

    <nav>
        <div style="margin-bottom:0px;">
        <ul class="grad2">
    <li style="margin-left: 10%" class="active"><a href="Index.php">Enter Your Location</a></li>
    <li style="float:right;margin-right:12.5%;"><a href=# class="icon" style="min-height:63px;"><i class="fa fa-instagram fa-fw" style="font-size:35px;"></i></a></li> 
    <li style="float:right;"><a href=# class="icon" style="min-height:63px;"><i class="fa fa-facebook fa-fw" style="font-size:35px"></i></a></li>
    <li style="float:right;"><a href=# class="icon" style="min-height:63px;"><i class="fa fa-twitter fa-fw" style="font-size:35px"></i></a></li> 
        </ul>
    </div>
    </nav>
    <!--<br> <br><br>-->
    <div class="wrapper" style="width:80%">
    <div id=".loc" style="width:50%;float:left;min-height:25px;">
    </div>
    <div style="width:50%;float:left;min-height:25px;">
    </div>
    </div>
	<div id="map" style="width:100%;height:400px"></div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<!--http://biostall.com/loading-infowindow-content-using-ajax-with-google-maps-api/-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script>
        
        
		var lastOpenedInfoWindow;
		var parsedObj;
		
		var stationsLatestData;
		
	
	
		
		
		function myMap() {
 // https://www.w3schools.com/js/js_json_http.asp
             function checkNumbers(url) {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			parsedObj = JSON.parse(this.responseText);
            myFunction(parsedObj);
			
		}
	};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
             }
            
            
        function myFunction(arr) {
      
			var mapOptions = {
				center: new google.maps.LatLng(53.350140, -6.266155),
				zoom: 14,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			}
		var map = new google.maps.Map(document.getElementById("map"), mapOptions);
        var i;
         for(i = 0; i < arr.length; i++){
            var radiusOut;
			var colorOut;
            var ratio = arr[i].available_bikes/arr[i].bike_stands;
            if (ratio<0.001){
                colorOut='#FF0000';
			    radiusOut=40;
            } 
			else if (ratio<.6&&ratio>0.001){
			    colorOut='#0000FF';
			    radiusOut=60;
			}
			else{
			    colorOut='#0000FF';
			    radiusOut=100*ratio;
			}
            var cityCircle = new google.maps.Circle({
                strokeColor: colorOut,
                strokeOpacity: 0.8,
                strokeWeight: 0.5,
                fillColor: colorOut,
                fillOpacity: 0.35,
                map: map,
                center:{lat:arr[i].lat,lng:arr[i].lng},
                position: {lat:arr[i].lat,lng:arr[i].lng},
                radius: radiusOut,
				number: arr[i].number
            });
            var contentString;
            
            var infowindow = new google.maps.InfoWindow();
            var num = cityCircle.number;
           google.maps.event.addListener(cityCircle,'click',(function( cityCircle,contentString,infowindow) {
               return function(){
				   $.ajax({  
                url: "http://localhost:5000/available/"+cityCircle.number,  
                success: function(data) { 
                        infowindow.setContent('<b>Station Number: '+data[0].number +'</b><br>'+ data[0].address+'<br>Available bikes: '+data[0].available_bikes+"<br>Available stands: "+data[0].available_bike_stands);  
						infowindow.open(map, cityCircle);
						closeLastOpenedInfoWindow();
						lastOpenedInfoWindow = infowindow; 
					
						// if  infowindow.setContent, infowindow.open, closeLastOpenedInfoWindow, lastOpenedInfoWindow  are above google.charts 1st  			
					
                        google.charts.load('current', {'packages': ['corechart','bar']});
                        google.charts.setOnLoadCallback(drawInfoWindowChart);
						google.charts.load('current', {'packages':['corechart']});
                    	google.charts.setOnLoadCallback(init);
				//		drawInfoWindowChart();
						
						
						
                }  
            });     
				   function init(){
				       drawPieChart(cityCircle);
				   }
                 	 function drawPieChart(cityCircle) {
			 var jqxhr = $.getJSON("http://localhost:5000/available/" +
			cityCircle.number,      function (data) {		
				 
						
				 
							
			 		console.log('data');
					 	//var node = document.createElement('div')
							
				 	//chart = new google.visualization.ColumnChart(node);
				 
				 var chart_data = google.visualization.arrayToDataTable([
          ['Status', 'Number of bikes'],
			 ['Available bikes',  data[0].available_bikes  ],
			['Available bike stands',data[0].available_bike_stands  ]
         
          
        
        ]);
				 		
				
						//_.forEach(data, function (row) {
				 		//		//chart_data.addRow([new Date(row[0]), row[1]]);
				 		//}
	
				 
			 //chart.draw(chart_data, options);
			 //infowindow.setContent(node);
			 //infowindow.open(marker.getMap(), marker);
			 //}).fail(function () {
	
			// console.log("error");
				
				var options = {
					 title: 'Bike availability'
 };
// })  
		 
		  var chart = new google.visualization.PieChart(document.getElementById('graph1'));

      					chart.draw(chart_data, options);
         })		
			 }  
               }
        })(cityCircle,contentString,infowindow)); 
        }
    
        function drawInfoWindowChart() {
	/*		 var jqxhr = $.getJSON("http://localhost:5000/available/" +
			cityCircle.number,      function (data) {		 */
				 
						//data = JSON.parse(data.data);
				 
							
			 			console.log('data');
					 	//var node = document.createElement('div')
							
				 	//chart = new google.visualization.ColumnChart(node);
				 
				 	var chart_data = new google.visualization.DataTable();
			 			chart_data.addColumn('datetime', 'Time of Day');
				 		chart_data.addColumn('number', '#');
				 		
				chart_data.addRows([[new Date(2018-03-26),17.343312],[new Date(2018-03-27),17.328807],[new Date(2018-03-28),18.066599]]);
				
						var chart = new google.visualization.ColumnChart(
        					document.getElementById('graph2'));

      					chart.draw(chart_data, options);
						
			 			//_.forEach(data, function (row) {
				 		//		//chart_data.addRow([new Date(row[0]), row[1]]);
				 		//}
	
				 
			 //chart.draw(chart_data, options);
			 //infowindow.setContent(node);
			 //infowindow.open(marker.getMap(), marker);
			 //}).fail(function () {
	
			// console.log("error");
				
				var options = {
					 title: 'Availability',
					 colors: ['#9575cd',
					'#33ac71'],
					 hAxis: {
					 title: 'Time of Day',
					 format: "E HH:mm",
					 slantedText: true,
					 slantedTextAngle: 30,
					 },
					 vAxis: { title: '#'
					 }
 };
// })  
            document.location.href="#.loc";   
         }
			
			

			
			
			
			
			
			
			
			
            
        function closeLastOpenedInfoWindow(){
			if (lastOpenedInfoWindow) {
        lastOpenedInfoWindow.close();
    }
}
         
        }
		
			
                checkNumbers("http://localhost:5000/orlaJSON");		
		//	setInterval(checkNumbers3(), 300000);
		
	}	
		
	
		
		
		
		
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?callback=myMap&key=AIzaSyDnhjzNlsrZqK3A_HtAfH0ya2hmN0qQAzs" async defer ></script>
	
    <div class="wrapper" style="width:80%">
    <div style="width:50%;float:left;min-height:25px;">
    </div>
    <div  style="width:50%;float:left;min-height:25px;">
    </div>
    <div id="graph1"style="width:50%;float:left;">
    </div>
    <div id="graph2" style="width:50%;float:left;">
    </div>
    </div>
    
    <div class="grad2 footertop">
            
            <form style="margin-right:5%">
              Name:
            <input type="text" name="firstname">
              Email:
            <input type="text" name="lastname">
            <input type="submit" style="width:100px;height:24px;">
            </form>
            <h5 style="font-weight:none;">Join our Mailing List!</h5>
    </div>
    
    <div class="footer grad2" style="padding:10px 0px 20px 0px;min-height:130px;">

    <ul style="list-style-type:none;padding:0;font-weight:none;">    
        <li><h5 style="font-family:sans-serif;">Copyright Dublin Bikes Â©</h5></li>
    </ul>
</div>
    
    </body>
</html>

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>
		Dublin Bikes
	</title>
 
</head>
<body id="body">
	

    <br> <br><br>
	<div id="map" style="width:100%;height:400px"></div>
	<!--http://biostall.com/loading-infowindow-content-using-ajax-with-google-maps-api/-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script>
		var lastOpenedInfoWindow;
		var parsedObj;
		
		var stationsLatestData;
		
	
			
		  function checkNumbers3(url) {
			  //do query modify global object
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			parsedObj = JSON.parse(this.responseText);
            myFunction(parsedObj);
			
		}
	};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
             }
		
		
		function myMap() {
 // https://www.w3schools.com/js/js_json_http.asp
             function checkNumbers(url) {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			parsedObj = JSON.parse(this.responseText);
            myFunction(parsedObj);
			
		}
	};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
             }
            
            
        function myFunction(arr) {
      
			var mapOptions = {
				center: new google.maps.LatLng(53.350140, -6.266155),
				zoom: 14,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			}
		var map = new google.maps.Map(document.getElementById("map"), mapOptions);
        var i;
         for(i = 0; i < arr.length; i++){
            var radiusOut;
			var colorOut;
			if (arr[i].available_bikes<5){
			    colorOut='#B30000';
			    radiusOut=48;
			}
			else if (arr[i].available_bikes>5&&arr[i].available_bikes<10){
			    colorOut='#FF0000';
			    radiusOut=62;	
			}
			else if(arr[i].available_bikes>10&&arr[i].available_bikes<18){
			    colorOut='#0000FF';
			    radiusOut=62;	
			}
			else{
			    colorOut='#000099';
			    radiusOut=70;
			}
            var cityCircle = new google.maps.Circle({
                strokeColor: colorOut,
                strokeOpacity: 0.8,
                strokeWeight: 0.5,
                fillColor: colorOut,
                fillOpacity: 0.35,
                map: map,
                center:{lat:arr[i].lat,lng:arr[i].lng},
                position: {lat:arr[i].lat,lng:arr[i].lng},
                radius: radiusOut,
				number: arr[i].number
            });
            var contentString;
            
            var infowindow = new google.maps.InfoWindow();
            var num = cityCircle.number;
           google.maps.event.addListener(cityCircle,'click',(function( cityCircle,contentString,infowindow) {
               return function(){
				   $.ajax({  
                url: "http://localhost:5000/available/"+cityCircle.number,  
                success: function(data) { 
                        infowindow.setContent('<b>Station Number: '+data[0].number +'</b><br>'+ data[0].address+'<br>Available bikes: '+data[0].available_bikes+"<br>Available stands: "+data[0].available_bike_stands);  
						infowindow.open(map, cityCircle); 
						closeLastOpenedInfoWindow();
						lastOpenedInfoWindow = infowindow; 
                }  
            });
          
               };
        })(cityCircle,contentString,infowindow)); 
        }
    
        function closeLastOpenedInfoWindow(){
			if (lastOpenedInfoWindow) {
        lastOpenedInfoWindow.close();
    }
}
        
        }        
		
			
                checkNumbers("http://localhost:5000/orlaJSON");		
			setInterval(checkNumbers3(), 300000);
		
	}	
		
	
		
		
		
		
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?callback=myMap&key=AIzaSyDnhjzNlsrZqK3A_HtAfH0ya2hmN0qQAzs" ></script>
	

	<button onclick=" myMap()">Click me</button>
	
	
    <br>
    <br> <br> <br>   <br>  <br>

    <div id="/test">
        <div class="footer">
        </div>
     </div>
    </body>
</html>
